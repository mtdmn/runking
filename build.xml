<?xml version="1.0" encoding="utf-8"?>
<project name="CakePHP" default="build">
	<taskdef classname="phing.tasks.ext.d51PearPkg2Task" name="d51pearpkg2" />

	<property file="build.properties" />
	<property name="package" value="${phing.project.name}" override="true" />

	<!--
		The set of files we're going to package
		Exclude the cli scripts, as they get installed separately.
	 -->
	<fileset id="libs" dir="./lib/Cake">
		<include name="**" />
		<exclude name="Console/cake.bat" />
		<exclude name="Console/cake.php" />
		<exclude name="Console/cake" />
	</fileset>

	<!--
		CLI scripts to package and install
	-->
	<fileset id="cli" dir="./lib/Cake/Console">
		<include name="cake.bat" />
		<include name="cake.php" />
		<include name="cake" />
	</fileset>


	<!-- start fresh each time.  Remove the dist and build dirs -->
	<target name="clean">
		<delete dir="${build.dir}" includeemptydirs="true" />
		<delete dir="${dist.dir}" includeemptydirs="true" />
	</target>

	<!-- makes directories and sets properties -->
	<target name="prepare" depends="clean">
		<echo msg="Creating build + dist directories." />
		<mkdir dir="${build.dir}" />
		<mkdir dir="${dist.dir}" />

		<exec executable="php" outputProperty="version">
			<arg value="-r" />
			<arg value="$fh = file('./lib/Cake/VERSION.txt'); echo array_pop($fh);" />
		</exec>

		<!-- set PEAR stability based on version number. -->
		<condition property="pear.stability" value="beta">
			<contains string="${version}" substring="beta" casesensitive="false"/>
		</condition>
		<condition property="pear.stability" value="alpha">
			<contains string="${version}" substring="alpha" casesensitive="false"/>
		</condition>
		<condition property="pear.stability" value="devel">
			<contains string="${version}" substring="dev" casesensitive="false"/>
		</condition>
		<condition property="pear.stability" value="beta">
			<contains string="${version}" substring="rc" casesensitive="false" />
		</condition>
		<condition property="pear.stability" value="stable">
			<not><isset property="pear.stability"/></not>
		</condition>

		<!-- pear versions need to not have '-' -->
		<exec executable="php" outputProperty="pear.version">
			<arg value="-r" />
			<arg value="echo str_replace(array('-'), array(''), '${version}');" />
		</exec>

		<echo msg="Preparing package of ${version} (${pear.version}+${pear.stability})" />
	</target>

	<!--
		Copy all the files to build/ so they can be packaged up.
	-->
	<target name="copy-files" depends="prepare">
		<echo msg="Copying files to build directory" />
		<copy todir="${build.dir}/${project.name}-${version}/Cake">
			<fileset refid="libs" />
		</copy>
		<copy todir="${build.dir}/${project.name}-${version}/bin">
			<fileset refid="cli" />
		</copy>
	</target>

	<!--
		Define the package.xml.  Using xml to make xml is fun!
	-->
	<target name="define-pear-package" depends="copy-files">
		<d51pearpkg2 baseinstalldir="/" dir="${build.dir}/${project.name}-${version}">
			<name>CakePHP</name>
			<summary>CakePHP Framework</summary>
			<channel>pear.php.net</channel>
			<description>CakePHP </description>
			<lead user="mark_story" name="Mark Story" email="mark@mark-story.com" />
			<license>MIT License</license>
			<version release="${pear.version}" api="${pear.version}" />
			<stability release="${pear.stability}" api="${pear.stability}" />
			<notes>http://github.com/cakephp/cakephp/blob/master/README</notes>
			<dependencies>
				<php minimum_version="5.2.9" />
				<pear minimum_version="1.9.0" recommended_version="1.9.4" />
				<package name="PHPUnit" channel="pear.phpunit.de" minimum_version="3.5.0" type="optional" />
			</dependencies>
			<dirroles key="bin">script</dirroles>
			<release>
				<install as="cake" name="bin/cake" />
				<install as="cake.php" name="bin/cake.php" />
				<install as="cake.bat" name="bin/cake.bat" />
			</release>
		</d51pearpkg2>
	</target>

	<!-- Generate the PEAR package from a directory and move the files to the dist folder -->
	<target name="generate-package" depends="define-pear-package">
		<exec command="pear package" dir="${build.dir}/${project.name}-${version}" passthru="true"/>
		<echo msg="Moving ${project.name}-${pear.version}.tgz"/>
		<move file="${build.dir}/${project.name}-${version}/${project.name}-${pear.version}.tgz" todir="${dist.dir}" />
	</target>

	<!-- top level easy to type target -->
	<target name="build" depends="generate-package" />


	<!--
		Bump the version number and commit that.
	-->
	<target name="next-version" depends="prepare">
		<echo msg="Incrementing version." />
		<propertyprompt propertyName="release_version" defaultValue="${version}" promptText="Enter version to be released (without -DEV)"/>
		<echo msg="New version will be ${release_version}" />
		<echo msg="$file = file_get_contents('./lib/Cake/VERSION.txt'); $file = str_replace('${version}', '${release_version}', $file); file_put_contents('./lib/Cake/VERSION.txt', $file);" />
		<exec executable="php">
			<arg value="-r" />
			<arg value="$file = file_get_contents('./lib/Cake/VERSION.txt'); $file = str_replace('${version}', '${release_version}', $file); file_put_contents('./lib/Cake/VERSION.txt', $file);" />
		</exec>

	</target>


</project>
